================================================================================
                    AL-MUALLIM BOT - PROJECT DOCUMENTATION
                    مشروع المُعلم - التوثيق الكامل
================================================================================

Updated: January 15, 2026
Version: 2.0 (Multi-Tenant PWA)

=== OVERVIEW ===

Al-Muallim Bot (المُعلم) is an intelligent Telegram USERBOT designed to automatically 
grade handwritten physics exams using AI-powered analysis. 

Version 2.0 adds a MULTI-TENANT PWA system allowing ANY teacher to sign up
and use the grading bot on their own Telegram account.

The name "Al-Muallim" (المُعلم) means "The Teacher" in Arabic.


=== CURRENT DEPLOYMENT ===

LIVE URL: http://34.71.188.46:8000

GCP VM DETAILS:
- Name: al-muallim-bot
- Zone: us-central1-a
- Machine Type: e2-micro (Free tier eligible)
- OS: Debian GNU/Linux 12
- Disk: 30GB
- Static IP: 34.71.188.46 (Reserved as 'al-muallim-static-ip')
- Firewall Rule: allow-http-8000 (TCP 8000 from 0.0.0.0/0)

⚠️ IMPORTANT NOTES:
1. The IP is EPHEMERAL - consider reserving a static IP in GCP
2. The SQLite database is stored on the VM - backup if needed
3. If VM is deleted, all teacher sessions and quiz records are lost


=== ARCHITECTURE ===

OLD (v1.0 - Single User):
  userbot.py → ONE teacher's account → ONE global quiz

NEW (v2.0 - Multi-Tenant):
  PWA Frontend → FastAPI Backend → Bot Manager → MULTIPLE teachers


SYSTEM COMPONENTS:
------------------

                    ┌─────────────────────────────────────────┐
                    │        GCP Cloud (107.178.217.60)       │
                    ├─────────────────────────────────────────┤
                    │  PWA Frontend ───→ FastAPI Backend      │
                    │  (Arabic UI)        ├── /auth (login)   │
                    │                     ├── /quiz (upload)  │
                    │                     └── /status         │
                    │                          │              │
                    │                    Bot Manager          │
                    │              ┌─────────────────┐        │
                    │              │ Teacher 1 Bot   │        │
                    │              │ Teacher 2 Bot   │        │
                    │              │ Teacher N Bot   │        │
                    │              └─────────────────┘        │
                    │              ┌─────────────────┐        │
                    │              │ 3 Grading Workers│       │
                    │              │ (Shared Queue)   │        │
                    │              └─────────────────┘        │
                    │                     │                   │
                    │              PhysicsGrader              │
                    │           (Gemini 3 Pro Preview)        │
                    └─────────────────────────────────────────┘


=== HOW IT WORKS ===

FOR TEACHERS:
1. Open http://107.178.217.60:8000
2. Enter phone number (with country code)
3. Enter the code received on Telegram
4. Upload a quiz image
5. Done! Bot is now running on their account

FOR STUDENTS:
1. Send a photo of their answer to the teacher's Telegram
2. Bot automatically grades it
3. Graded result appears as a scheduled message


=== AI GRADING ===

MODEL: Gemini 3 Pro Preview
(Configured in config.py: GEMINI_MODEL = "gemini-3-pro-preview")

THE GRADING CODE IS UNCHANGED from v1.0:
- grading/grader.py - PhysicsGrader class
- grading/annotator.py - draws ✓ ✗ ! symbols on answers
- utils/ocr_detector.py - text detection

SCORING:
- Score out of 10
- ✓ Green = Correct
- ✗ Red = Mistake
- ! Yellow = Partially correct


=== PROJECT STRUCTURE ===

al-muallim-bot/
│
├── backend/                    # NEW: Multi-tenant backend
│   ├── main.py                 # FastAPI app with lifespan events
│   ├── database.py             # SQLAlchemy models (Teacher, Quiz, PendingAuth)
│   ├── bot_manager.py          # Multi-session Telethon manager
│   ├── requirements.txt        # Backend dependencies
│   ├── routes/
│   │   ├── auth.py             # Telegram login flow
│   │   ├── quiz.py             # Quiz upload/management
│   │   └── status.py           # System status endpoints
│   └── static/
│       └── index.html          # PWA frontend (Arabic, dark theme)
│
├── grading/                    # UNCHANGED from v1.0
│   ├── grader.py               # PhysicsGrader using Gemini
│   └── annotator.py            # Image annotation
│
├── config.py                   # Configuration (model, API keys)
├── userbot.py                  # Original single-user bot (still works)
├── .env                        # API keys (local)
├── .gitignore                  # Protects sensitive files
└── curriculum/                 # Physics curriculum PDFs


=== ENVIRONMENT VARIABLES ===

Required on the GCP VM (.env file in ~/al-muallim-bot/):

TELEGRAM_API_ID=30619302
TELEGRAM_API_HASH=a501dc4dd3e7e2288cdc3dc18ff9e3ce
GOOGLE_API_KEY=<your-google-api-key>
GEMINI_MODEL=gemini-3-pro-preview


=== RUNNING THE SERVER ===

ON GCP VM:
cd ~/al-muallim-bot/backend
nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &

TO VIEW LOGS:
tail -f ~/al-muallim-bot/backend/backend.log

TO RESTART:
pkill -f uvicorn
cd ~/al-muallim-bot/backend && nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &

TO UPDATE FROM GITHUB:
cd ~/al-muallim-bot && git pull


=== SECURITY ===

The .gitignore protects:
✓ .env - API keys
✓ *.session - Telegram session files
✓ gen-*.json - Google Cloud credentials
✓ *.log - Log files
✓ temp_images/ - Temporary files

STORED ON VM (not in Git):
- almuallim.db - SQLite database with teacher sessions
- quizzes/ - Uploaded quiz images


=== CHANGELOG ===

January 15, 2026:
- Increased score circle radius from 60px to 90px for better visibility
- Increased score font size from 50px to 72px
- Fixed font loading on Linux: now tries multiple system fonts
  (DejaVuSans-Bold, LiberationSans-Bold, etc.) instead of just arial.ttf
- Server runs 24/7 on GCP VM - no daily restarts needed
- Curriculum PDFs are cached on server startup, not re-uploaded per grading


=== MANAGING TEACHERS ===

TO VIEW ALL TEACHERS:
cd ~/al-muallim-bot/backend
sqlite3 teachers.db "SELECT * FROM teachers;"

TO REMOVE A TEACHER:
sqlite3 teachers.db "DELETE FROM teachers WHERE id = <teacher_id>;"
# Then restart the server

NOTE: If a teacher has 2FA (two-step verification) on Telegram, they must
temporarily disable it during registration, then re-enable it after.


=== FUTURE IMPROVEMENTS ===

1. DOMAIN NAME
   - Point a domain to the static IP 34.71.188.46
   - Set up HTTPS with Let's Encrypt

2. DATABASE BACKUP
   - Consider backing up almuallim.db periodically
   - Or migrate to Cloud SQL for persistence

3. SYSTEMD SERVICE
   - Create a systemd service for auto-restart on boot

4. 2FA SUPPORT
   - Add cloud password field to registration flow


=== GIT COMMANDS ===

All code is stored at: https://github.com/itsm0000/al-muallim-bot

TO SAVE CHANGES:
git add -A
git commit -m "Description of changes"
git push

TO DEPLOY TO GCP:
1. Push to GitHub
2. SSH to VM: gcloud compute ssh al-muallim-bot --zone=us-central1-a
3. Pull and restart:
   cd ~/al-muallim-bot && git pull
   pkill -f uvicorn
   cd backend && nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &


=== CREDITS ===

- AI Model: Google Gemini 3 Pro Preview
- Curriculum: Hussein Mohammed - Physics 2025 (حسين محمد - فيزياء 2025)
- Framework: FastAPI + Telethon
- Frontend: Vanilla HTML/CSS/JS PWA


================================================================================
                          END OF DOCUMENTATION
================================================================================
